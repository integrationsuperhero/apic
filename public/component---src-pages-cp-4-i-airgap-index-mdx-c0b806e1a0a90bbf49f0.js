"use strict";(self.webpackChunkcloudpak_integration=self.webpackChunkcloudpak_integration||[]).push([[7213,4624,1937,281,9195,4883,8436,2258,2056],{3498:function(e,t,a){a.r(t),a.d(t,{_frontmatter:function(){return s},default:function(){return k}});var n=a(3366),r=(a(7294),a(4983)),o=a(4295),i=a(6767),l=["components"],s={},c=function(e){return function(t){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),(0,r.kt)("div",t)}},p=c("AnchorLinks"),m=c("AnchorLink"),d={_frontmatter:s},u=o.Z;function k(e){var t=e.components,a=(0,n.Z)(e,l);return(0,r.kt)(u,Object.assign({},d,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)(i.Z,{name:"Cesar Cavazos",lastUpdated:"July 2021",mdxType:"ArticleDetails"}),(0,r.kt)("h1",null,"Airgap Install Cloud Pak for Integration 2021.2"),(0,r.kt)(p,{mdxType:"AnchorLinks"},(0,r.kt)(m,{mdxType:"AnchorLink"},"General Notes"),(0,r.kt)(m,{mdxType:"AnchorLink"},"Prerequisites"),(0,r.kt)(m,{mdxType:"AnchorLink"},"Infrastructure Requirements"),(0,r.kt)(m,{mdxType:"AnchorLink"},"Installation"),(0,r.kt)(m,{mdxType:"AnchorLink"},"Bastion Host Tools"),(0,r.kt)(m,{mdxType:"AnchorLink"},"Docker registry running in bastion host"),(0,r.kt)(m,{mdxType:"AnchorLink"},"Cloud Pak for Integration"),(0,r.kt)(m,{mdxType:"AnchorLink"},"Create the Catalog Source (Operator Catalog)"),(0,r.kt)(m,{mdxType:"AnchorLink"},"Useful References")),(0,r.kt)("h2",null,"General Notes"),(0,r.kt)("p",null,"This guide assumes that you are mirroring all the images for the Cloud Pak. Although, there are specific CASE archives for the each of the Cloud Pak components available in the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/IBM/cloud-pak/tree/master/repo/case"},"IBM CASE repository"),"."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"For the official set of instructions for deployment visit the ",(0,r.kt)("a",{parentName:"p",href:"https://www.ibm.com/docs/en/cloud-paks/cp-integration/2021.2?topic=icpiiage-installing-cloud-pak-integration-in-air-gapped-environment-using-bastion-host"},"Cloud Pak for Integration documentation site"),".")),(0,r.kt)("h2",null,"Prerequisites"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"1. Access to GitHub.com.")," The CASE archive (offline installer) is available at ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/IBM/cloud-pak/blob/master/repo/case/ibm-cp-integration-2.3.0.tgz"},"GitHub"),"."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"If GitHub is not accessible from the bastion host you can download, transfer and save the CASE file locally and proceed with the installation with the local path as opposed to the GitHub URL.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"2. Access to raw.githubusercontent.com")," The dependencies for the CASE archive are resolved by accessing a YAML file stored in GitHub.com using the raw hostnames. ",(0,r.kt)("a",{parentName:"p",href:"https://raw.githubusercontent.com/IBM/cloud-pak/master/repo/case/index.yaml"},"YAML file location.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"3. Access to container registries.")," Images are located in the following registries. Make sure the bastion host has access to the registries: "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"icr.io:443 (IBM Entitled Registry)"),(0,r.kt)("li",{parentName:"ul"},"*.docker.io (DockerHub Registry)"),(0,r.kt)("li",{parentName:"ul"},"*.docker.com (DockerHub Registry)"),(0,r.kt)("li",{parentName:"ul"},"quay.io:443 (Quay Container Registry by Red Hat)")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"4. Access to Red Hat")," for OpenShift Container Platform upgrades"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"redhat.com")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"5. IBM Entitled Registry key.")," See ",(0,r.kt)("a",{parentName:"p",href:"https://www.ibm.com/support/knowledgecenter/SSGT7J_20.4/install/entitlement_key.html"},"IBM Entitled Registry entitlement keys")," for how to obtain your entitlement key."),(0,r.kt)("h2",null,"Infrastructure Requirements"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"OpenShift Cluster 4.7.X ",(0,r.kt)("em",{parentName:"li"},"(4.7.16 used for this guide)")),(0,r.kt)("li",{parentName:"ul"},"Private Container Registry",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Must support Docker ",(0,r.kt)("a",{parentName:"li",href:"https://docs.docker.com/registry/spec/manifest-v2-2/"},"Manifest V2, Schema 2")),(0,r.kt)("li",{parentName:"ul"},"Accessible from both bastion host and the OpenShift cluster nodes"),(0,r.kt)("li",{parentName:"ul"},"Username and password to read (from OpenShift) and write (from bastion host)"),(0,r.kt)("li",{parentName:"ul"},"Allows path separators in the image name"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"OpenShift’s internal registry is not supported")))),(0,r.kt)("li",{parentName:"ul"},"Bastion Host",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Access to internet and OpenShift cluster"),(0,r.kt)("li",{parentName:"ul"},"4 CPU / 8 GB RAM ",(0,r.kt)("em",{parentName:"li"},"(8 CPU / 16 GB recommended)")),(0,r.kt)("li",{parentName:"ul"},"100 GB available storage in HD",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"If you are planning to use a docker registry images within this bastion host, as this guide does, and additional 220 GB are needed"))),(0,r.kt)("li",{parentName:"ul"},"This guide assumes the OS to be RHEL/CentOS 8. You may have to adjust the commands to match newer versions or a different OS"),(0,r.kt)("li",{parentName:"ul"},"Tools",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"openssl > 1.11.1")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"docker"),". Alternative you can use ",(0,r.kt)("inlineCode",{parentName:"li"},"podman"),". "),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"skopeo")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"httpd-tools")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"oc")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"cloudctl")," ",(0,r.kt)("em",{parentName:"li"},"See below for installation instructions.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"ibmcloud")," for ROKS ",(0,r.kt)("em",{parentName:"li"},"See below for installation instructions."))))))),(0,r.kt)("h2",null,"Installation"),(0,r.kt)("h3",null,"Bastion Host Tools"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Check for updates"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"yum check-update\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Install ",(0,r.kt)("inlineCode",{parentName:"p"},"yum-utils")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"httpd-tools")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"yum install -y yum-utils httpd-tools\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"To install the latest docker version add the appropriate repo"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Uninstall previous docker versions and install the latest"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"yum remove docker \\\n      docker-client \\\n      docker-client-latest \\\n      docker-common \\\n      docker-latest \\\n      docker-latest-logrotate \\\n      docker-logrotate \\\n      docker-engine\n              \nyum install -y docker-ce docker-ce-cli containerd.io\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Start the docker services and test that it works"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl start docker\ndocker run hello-world\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Install ",(0,r.kt)("inlineCode",{parentName:"p"},"skopeo")," (For other installers visit the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/containers/skopeo/blob/master/install.md"},"docs at Skopeo"),")"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# RHEL/CentOS 8 only\nsudo dnf -y install skopeo\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Install ",(0,r.kt)("inlineCode",{parentName:"p"},"cloudctl")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"wget https://github.com/IBM/cloud-pak-cli/releases/latest/download/cloudctl-linux-amd64.tar.gz\n\ntar -xf cloudctl-linux-amd64.tar.gz\nchmod 755 cloudctl-linux-amd64\nmv cloudctl-linux-amd64 /usr/local/bin/cloudctl\n\n# Validate that it works\ncloudctl help\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Install OpenShift CLI ",(0,r.kt)("inlineCode",{parentName:"p"},"oc"),". This can be installed either from RedHat or from the OpenShift Cluster. You can ",(0,r.kt)("a",{parentName:"p",href:"https://docs.openshift.com/container-platform/4.7/cli_reference/openshift_cli/getting-started-cli.html"},"follow the instructions directly from Red Hat")," or install it from the cluster:"))),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"From the OpenShift console click on the help button and select ",(0,r.kt)("inlineCode",{parentName:"p"},"Command line tools")),(0,r.kt)("span",{parentName:"li",className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"1152px"}},"\n      ",(0,r.kt)("span",{parentName:"span",className:"gatsby-resp-image-background-image",style:{paddingBottom:"32.63888888888889%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABkUlEQVQoz32PTWsaQRjHl95UgqFNNC8bW9YmVRuTvtiXlBAILf0CJSQESqAUSb5KP4EXXYk5eM2136A5e/QkeGjq67qz7ro7+ys7wZxK//Bj5nmG+T0z2l4+z8vSazZ0HV3XSSaTxONxRSwWuyeRSJBOpzEMg0wmg2FkWV1ZZvGRwYP1H8RWzkgtLaAVi7vkCtus6Rk+fvpM3TSpVCrUajVM01RUq1WazSatVot2u02n06Hb7XJz8wuz3qDW+Em9cc3V1SXa02cFnmS3WFxKc/r1jCjWZMK/4jgOo9GI/0Urvd2j9O4DheILyucX/LE8+mNBr9fj9+0tg8FA7SMsy2I8HqtVCIHrumoVwlHDpo6Dtn9wyKs378k93+Hb9zK2bTMcDgmCgMC/w/d9ZrOZEkWSqJ73PM+7OxMuo8kULbuV57GxycPUKl+OTph6U4RjQwie76o6lCFSSiWcfzkMQyWaR4YQyBAtv72DsZkjtbbB0fEpru9iO7Z6oed72GKiLkoZKFm/31eyuTAaFKF6UvIXLTuqseSdS1EAAAAASUVORK5CYII=')",backgroundSize:"cover",display:"block"}}),"\n  ",(0,r.kt)("img",{parentName:"span",className:"gatsby-resp-image-image",alt:"install oc 1",title:"install oc 1",src:"/static/637c84a7ae6b67b7a0c9d7e5c5e5d31d/3cbba/install_oc_1.png",srcSet:["/static/637c84a7ae6b67b7a0c9d7e5c5e5d31d/7fc1e/install_oc_1.png 288w","/static/637c84a7ae6b67b7a0c9d7e5c5e5d31d/a5df1/install_oc_1.png 576w","/static/637c84a7ae6b67b7a0c9d7e5c5e5d31d/3cbba/install_oc_1.png 1152w","/static/637c84a7ae6b67b7a0c9d7e5c5e5d31d/9ba95/install_oc_1.png 1192w"],sizes:"(max-width: 1152px) 100vw, 1152px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy",decoding:"async"}),"\n    ")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Right-click on the link that you need and select ",(0,r.kt)("inlineCode",{parentName:"p"},"Copy link")),(0,r.kt)("span",{parentName:"li",className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"996px"}},"\n      ",(0,r.kt)("span",{parentName:"span",className:"gatsby-resp-image-background-image",style:{paddingBottom:"63.19444444444444%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACJElEQVQ4y42SWW/aQBSF/cbyhiASagOELUnTJqUsTZuWLWml/kFAQgh+TdX/EClqVVSMsT228QI2mFPNTW2R5aGWju5oNP7m3HtGuDg4wLdOB9V6HZlMBrlcDslkEvF4/IFisRii0SjVSCRCZ9LpNBKJRFhTqRSEQrGMYukYhVIZ2VwelWoN/f4Ag8EAvV4P/X6fNBwOMRqNQo3HY0wmkydVqDY+4LxSQ750ghfZPNrXX2HbNlaODcsy4VC18L+fcPr6Atl8iYCHuQI+tzqQmQ7bA8z1Frbr00Hf97HdbkNtNptnJVSqDZROzgj4MlvAVbMNTTfguBssTRuWs8J6vYbruqRgvdvtnrjje0Lt/UcUyqf/gHl8anagKAoYY5hOp5AkCaIoUp3P5+E6gHK33D0XAd/VLwkWAltd+sHQGQyNYWnoMHQNTFWh6zpdxKWqKl3Mz8qyjMViAU3TILx5WyUYdxk4lGUFInMgGS4Uc0Oy1xvsfD+c1f489yUECXNg5qiIVucGc1nFjzsL32813P1huP0tYyrKlHrQ3mN5nnffcuPyimABsN29wUJh+KV6+ClZ0BiDxhRqSZIW5CIIYL9yIAcLZ+cVFI9fEfDwqIhmuwtV0zEzfIjafcK6bsAwljTDwMl+ELzykAjIHXIgb5s7bHauwZgG1/VgmiYBZUXBarV6AHmssGXuMFcoE5Rm2P2C2UykBPkTcRyHwPutPqfgjf4F52YdwauOvNIAAAAASUVORK5CYII=')",backgroundSize:"cover",display:"block"}}),"\n  ",(0,r.kt)("img",{parentName:"span",className:"gatsby-resp-image-image",alt:"install oc 2",title:"install oc 2",src:"/static/0dd6a8a49ac1cc81d45398d56f20736e/2229d/install_oc_2.png",srcSet:["/static/0dd6a8a49ac1cc81d45398d56f20736e/7fc1e/install_oc_2.png 288w","/static/0dd6a8a49ac1cc81d45398d56f20736e/a5df1/install_oc_2.png 576w","/static/0dd6a8a49ac1cc81d45398d56f20736e/2229d/install_oc_2.png 996w"],sizes:"(max-width: 996px) 100vw, 996px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy",decoding:"async"}),"\n    ")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Install the ",(0,r.kt)("inlineCode",{parentName:"p"},"oc")," client but downloading it using ",(0,r.kt)("inlineCode",{parentName:"p"},"curl")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"wget")," and moving it to ",(0,r.kt)("inlineCode",{parentName:"p"},"/usr/local/bin/")))),(0,r.kt)("ol",{start:9},(0,r.kt)("li",{parentName:"ol"},"(Optional) If your cluster is running on IBM Cloud ROKS you will need the IBM Cloud CLI. Follow the steps in the ",(0,r.kt)("a",{parentName:"li",href:"https://cloud.ibm.com/docs/cli?topic=cli-getting-started"},"docs")," to install and configure it.")),(0,r.kt)("h3",null,"Docker registry running in bastion host"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"If you do not have a dedicated private registry available you can choose to deploy a docker registry within the bastion host to perform the offline installation. ",(0,r.kt)("strong",{parentName:"p"},"Skip to the next phase if you don’t need this."))),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"This Docker registry is insecure and not a best practice"),". It should ",(0,r.kt)("strong",{parentName:"p"},"NOT")," be performed in any other environment other than for learning in a playground environment. A production-grade registry needs to be installed and configured for long term usage for air gapped clusters.")),(0,r.kt)("p",null,"In this section we are going to run a Docker registry in the bastion host with self-signed certificates and basic authentication where we will store the mirrored images. ",(0,r.kt)("a",{parentName:"p",href:"https://docs.docker.com/registry/deploying/"},"Source")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'# Internal IP of the bastion host that the cluster can see\n# example: export LOCAL_DOCKER_REGISTRY=10.240.128.17:5000\nexport INTERNAL_IP=<registry_url>\nexport LOCAL_DOCKER_REGISTRY=$INTERNAL_IP:<port>\nexport LOCAL_DOCKER_USER=airgap\nexport LOCAL_DOCKER_PASSWORD=Cp4iD3pl0y\n\ncat > /etc/docker/daemon.json <<EOF\n{\n  "insecure-registries":["${LOCAL_DOCKER_REGISTRY}"]\n}\nEOF\n    \nsystemctl restart docker\n\nmkdir -p $HOME/docker-registry && cd $HOME/docker-registry\nmkdir -p certs\n\nopenssl req \\\n  -newkey rsa:4096 -nodes -sha256 -keyout certs/domain.key \\\n  -addext "subjectAltName = IP:$INTERNAL_IP" \\\n  -x509 -days 365 -out certs/domain.crt\n\nmkdir -p /etc/docker/certs.d/$LOCAL_DOCKER_REGISTRY/\ncp certs/domain.crt /etc/docker/certs.d/$LOCAL_DOCKER_REGISTRY/ca.crt\n\nmkdir auth\ndocker run \\\n  --entrypoint htpasswd \\\n  httpd:2 -Bbn $LOCAL_DOCKER_USER $LOCAL_DOCKER_PASSWORD > auth/htpasswd\n\nmkdir /mnt/registry\n\ndocker run -d \\\n  -p 5000:5000 \\\n  --restart=always \\\n  --name registry \\\n  -v /mnt/registry:/var/lib/registry \\\n  -v "$(pwd)"/auth:/auth \\\n  -e "REGISTRY_AUTH=htpasswd" \\\n  -e "REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm" \\\n  -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \\\n  -v "$(pwd)"/certs:/certs \\\n  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \\\n  -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \\\n  registry:2\n')),(0,r.kt)("h3",null,"Cloud Pak for Integration"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"To align with IBM Knowledge Center guides, we are going to assume that the files will be stored in ",(0,r.kt)("inlineCode",{parentName:"p"},"$HOME/offline"),". You can change this if you want to. Keep in mind that this location is referenced across many steps.")),(0,r.kt)("p",null,"Create a directory to hold the offline installation files"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir $HOME/offline\n")),(0,r.kt)("p",null,"Set the environment variables needed"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# CASE vars (CP4I 2021.2)\nexport CASE_NAME=ibm-cp-integration\nexport CASE_VERSION=2.3.0\nexport CASE_ARCHIVE=${CASE_NAME}-${CASE_VERSION}.tgz\nexport CASE_INVENTORY_SETUP=operator\nexport OFFLINEDIR=$HOME/offline\nexport CASE_REPO_PATH=https://github.com/IBM/cloud-pak/raw/master/repo/case\nexport CASE_LOCAL_PATH=$OFFLINEDIR/$CASE_ARCHIVE\n\n# Container registry vars\nexport LOCAL_DOCKER_REGISTRY=<registry_url:port>\nexport LOCAL_DOCKER_USER=<username>\nexport LOCAL_DOCKER_PASSWORD=<password>\n\n# OpenShift vars\nexport ENTITLED_REGISTRY_KEY=<ibm_entitlement_key>\nexport NAMESPACE=cp4i\n")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Login to the OpenShift cluster"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"oc login <cluster host:port> --username=<cluster-admin user> --password=<cluster-admin password>\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Create project (namespace) where CP4I will be installed"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"oc create namespace ${NAMESPACE}\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Download the CASE file and its dependencies to the local bastion host"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cloudctl case save \\\n--repo $CASE_REPO_PATH \\\n--case $CASE_NAME \\\n--version $CASE_VERSION \\\n--outputdir $OFFLINEDIR\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Configure the authentication secret for the local container registry."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'cloudctl case launch \\\n  --case $HOME/offline/${CASE_ARCHIVE} \\\n  --inventory ${CASE_INVENTORY_SETUP} \\\n  --action configure-creds-airgap \\\n  --args "--registry ${LOCAL_DOCKER_REGISTRY} --user ${LOCAL_DOCKER_USER} --pass ${LOCAL_DOCKER_PASSWORD}"\n'))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Configure the authentication credentials for the IBM Entitled Registry."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'cloudctl case launch \\\n  --case $HOME/offline/$CASE_ARCHIVE \\\n  --inventory $CASE_INVENTORY_SETUP \\\n  --action configure-creds-airgap \\\n  --args "--registry cp.icr.io --user cp --pass ${ENTITLED_REGISTRY_KEY}"\n'))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Mirror the images and configure the cluster. ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"Grab a cup of coffee or tea. This operation will take some time."))),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'cloudctl case launch \\\n  --case ${CASE_LOCAL_PATH} \\\n  --inventory ${CASE_INVENTORY_SETUP} \\\n  --action mirror-images \\\n  --args "--registry ${LOCAL_DOCKER_REGISTRY} --inputDir $OFFLINEDIR"\n'))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"(Optional) Configure Insecure Docker Registry on OpenShift"),(0,r.kt)("p",{parentName:"li"},"For insecure registries you must add the local registry to the insecureRegistries for your cluster"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'oc patch image.config.openshift.io/cluster --type=merge \\\n-p \'{"spec":{"registrySources":{"insecureRegistries":["\'${LOCAL_DOCKER_REGISTRY}\'"]}}}\'\n')),(0,r.kt)("p",{parentName:"li"},"If your container registry uses a self-signed certificate you need to create a ",(0,r.kt)("inlineCode",{parentName:"p"},"ConfigMap")," with the certificate file and patch the the cluster image configuration"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'# Note the `..` between the registry host and port.\nexport REGISTRY_HOST=<registry_host>\nexport REGISTRY_PORT=<registry_port>\noc create configmap registry-config --from-file=${REGISTRY_HOST}..${REGISTRY_PORT}=/path/to/cert/domain.crt -n openshift-config\n  \noc patch image.config.openshift.io/cluster --patch \'{"spec":{"additionalTrustedCA":{"name":"registry-config"}}}\' --type=merge\n')),(0,r.kt)("p",{parentName:"li"},"If you haven’t done it yet, you may also need to configure insecure registry access in your docker installation. If you are using a registry deployed in your bastion host you already did this step."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'cat > /etc/docker/daemon.json <<EOF\n{\n  "insecure-registries":["${LOCAL_DOCKER_REGISTRY}"]\n}\nEOF\n  \nsystemctl restart docker\n'))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Configure OpenShift cluster to access images from your private registry by setting up a global pull secret the ",(0,r.kt)("inlineCode",{parentName:"p"},"ImageContentSourcePolicy")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'cloudctl case launch \\\n--case $HOME/offline/$CASE_ARCHIVE \\\n--inventory $CASE_INVENTORY_SETUP \\\n--action configure-cluster-airgap \\\n--namespace $NAMESPACE \\\n--args "--registry $LOCAL_DOCKER_REGISTRY --user $LOCAL_DOCKER_USER --pass $LOCAL_DOCKER_PASSWORD --inputDir $OFFLINEDIR"\n')),(0,r.kt)("blockquote",{parentName:"li"},(0,r.kt)("p",{parentName:"blockquote"},"This step performs a rolling restart of all cluster nodes. The cluster resources might be unavailable until the new ImageContentSourcePolicy and global cluster pull secret is applied."))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"(Optional) If you are running on IBM Cloud ROKS, the automatic restart won’t happen. Follow the steps in this link to perform the rolling restart. ",(0,r.kt)("a",{parentName:"p",href:"https://playbook.cloudpaklab.ibm.com/cm/imagelocation/#Image_Pull_Mirroring_Redirection_for_Openshift_ROKS"},"Internal Reference")),(0,r.kt)("p",{parentName:"li"},"Make sure you are logged into the IBM Cloud CLI"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'# List all the worker nodes in the cluster\nibmcloud oc worker ls -c <cluster_name_or_id>\n\n# Reload each worker node for classic clusters\nibmcloud oc worker reload -c <cluster_name_or_id> -w <workerID_1> -w <workerID_2>\n\n# Replace each worker node for vpc-gen2 clusters\nibmcloud oc worker replace -c <cluster_name_or_id> -w <workerID_1> -w <workerID_2>\n\n# Grab another cup of coffee or tea. Depending on the number of nodes this could take some time.\n\n# Get all the worker node names (in ROKS is an IP)\noc get nodes\n\n# For each of the worker nodes\noc debug node/<worker_node_name>\nchroot /host\nvi etc/containers/registries.conf\n# Append the content of the gust below to the end of the file\n# REPLACE the "10.240.128.17:5000" with your registry value\n# https://gist.github.com/ccavazos/792ad565a72a7ba98b8bcb105f4cb920\nexit\nexit\nibmcloud cs worker reboot --cluster <cluster_name_or_id> -w <worker_id>\n')))),(0,r.kt)("h3",null,"Create the Catalog Source (Operator Catalog)"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Create the catalog source"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'cloudctl case launch \\\n--case $HOME/offline/${CASE_ARCHIVE} \\\n--inventory ${CASE_INVENTORY_SETUP} \\\n--action install-catalog \\\n--namespace ${NAMESPACE} \\\n--args "--registry ${LOCAL_DOCKER_REGISTRY} --inputDir $HOME/offline --recursive"\n'))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Verify that all the pods related to the Cloud Pak installer operator are running."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"oc get pods -n openshift-marketplace\n\noc get catalogsource -n openshift-marketplace\n")))),(0,r.kt)("p",null,"If you have reached this point successfully, congratulations! you can now proceed to deploy the Platform Navigation and/or any of the Cloud Pak for Integration 2021.2 components. "),(0,r.kt)("h2",null,"Useful References"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"OpenShift - Allowing insecure registries ",(0,r.kt)("a",{parentName:"p",href:"https://docs.openshift.com/container-platform/4.7/openshift_images/image-configuration.html#images-configuration-insecure_image-configuration"},"4.7"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Check the global pull secret of the cluster"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"oc get secret/pull-secret -n openshift-config -o yaml | grep -v f:.dockerconfigjson | grep -v .dockerconfigjson\\\" | grep -v /dockerconfigjson | grep .dockerconfigjson | awk '{print $2}' | base64 -d\n")))))}k.isMDXComponent=!0},4295:function(e,t,a){a.d(t,{Z:function(){return A}});var n=a(7294),r=a(8650),o=a.n(r),i=a(5444),l=a(6949),s=a(9337),c=a(5900),p=a.n(c),m=function(e){var t,a=e.title,r=e.theme,o=e.tabs,i=void 0===o?[]:o;return n.createElement("div",{className:p()("PageHeader-module--page-header--1JmOE",(t={},t["PageHeader-module--with-tabs--ezlJE"]=i.length,t["PageHeader-module--dark-mode--aV7If"]="dark"===r,t))},n.createElement("div",{className:"bx--grid"},n.createElement("div",{className:"bx--row"},n.createElement("div",{className:"bx--col-lg-12"},n.createElement("h1",{id:"page-title",className:"PageHeader-module--text--J1--B"},a)))))},d=function(e){var t=e.relativePagePath,a=e.repository,r=(0,i.useStaticQuery)("1364590287").site.siteMetadata.repository,o=a||r,l=o.baseUrl,s=o.subDirectory,c=l+"/edit/"+o.branch+s+"/src/pages"+t;return l?n.createElement("div",{className:"bx--row EditLink-module--row--2vJiZ"},n.createElement("div",{className:"bx--col"},n.createElement("a",{className:"EditLink-module--link--t_pLX",href:c},"Edit this page on GitHub"))):null},u=a(4275),k=a(1721),g=function(e){function t(){return e.apply(this,arguments)||this}return(0,k.Z)(t,e),t.prototype.render=function(){var e=this.props,t=e.title,a=e.tabs,r=e.slug,l=r.split("/").filter(Boolean).slice(-1)[0],s=a.map((function(e){var t,a=o()(e,{lower:!0,strict:!0}),s=a===l,c=new RegExp(l+"/?(#.*)?$"),m=r.replace(c,a);return n.createElement("li",{key:e,className:p()((t={},t["PageTabs-module--selected-item--3CjGa"]=s,t),"PageTabs-module--list-item--2X02I")},n.createElement(i.Link,{className:"PageTabs-module--link--2anNu",to:""+m},e))}));return n.createElement("div",{className:"PageTabs-module--tabs-container--18QsR"},n.createElement("div",{className:"bx--grid"},n.createElement("div",{className:"bx--row"},n.createElement("div",{className:"bx--col-lg-12 bx--col-no-gutter"},n.createElement("nav",{"aria-label":t},n.createElement("ul",{className:"PageTabs-module--list--3gLeN"},s))))))},t}(n.Component),h=a(2881),N=a(6958),f=a(36),b=function(e){var t=e.date,a=new Date(t);return t?n.createElement(f.X2,{className:"last-modified-date-module--row--Bb0E9"},n.createElement(f.sg,null,n.createElement("div",{className:"last-modified-date-module--text--1RmBx"},"Page last updated: ",a.toLocaleDateString("en-GB",{day:"2-digit",year:"numeric",month:"long"})))):null},A=function(e){var t=e.pageContext,a=e.children,r=e.location,c=e.Title,p=t.frontmatter,k=void 0===p?{}:p,f=t.relativePagePath,A=t.titleType,E=k.tabs,y=k.title,C=k.theme,R=k.description,S=k.keywords,_=k.date,I=(0,N.Z)().interiorTheme,w=(0,i.useStaticQuery)("2456312558").site.pathPrefix,O=w?r.pathname.replace(w,""):r.pathname,T=E?O.split("/").filter(Boolean).slice(-1)[0]||o()(E[0],{lower:!0}):"",L=C||I;return n.createElement(s.Z,{tabs:E,homepage:!1,theme:L,pageTitle:y,pageDescription:R,pageKeywords:S,titleType:A},n.createElement(m,{title:c?n.createElement(c,null):y,label:"label",tabs:E,theme:L}),E&&n.createElement(g,{title:y,slug:O,tabs:E,currentTab:T}),n.createElement(h.Z,{padded:!0},a,n.createElement(d,{relativePagePath:f}),n.createElement(b,{date:_})),n.createElement(u.Z,{pageContext:t,location:r,slug:O,tabs:E,currentTab:T}),n.createElement(l.Z,null))}}}]);
//# sourceMappingURL=component---src-pages-cp-4-i-airgap-index-mdx-c0b806e1a0a90bbf49f0.js.map